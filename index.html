<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Miary Podaży Pieniądza w Polsce</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/dist/date-fns.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    body{font-family:'Inter',sans-serif;background:#f5f5f5;margin:0;padding:0;}
    header{background:#fff;padding:1rem;box-shadow:0 2px 4px rgba(0,0,0,0.1);position:sticky;top:0;z-index:10;}
    .wrapper{display:flex;height:calc(100vh - 68px);}
    #sidebar{width:300px;background:#fff;padding:1rem;box-shadow:2px 0 4px rgba(0,0,0,0.1);overflow-y:auto;}
    #sidebar ul{list-style:none;padding:0;margin:0;}
    #sidebar li{margin:0.3rem 0;}
    #sidebar .node{display:flex;align-items:center;cursor:pointer;border-radius:6px;padding:0.4rem 0.6rem;}
    #sidebar .node:hover{background:#e6f0ff;}
    #sidebar .node.active>span{font-weight:600;}
    #sidebar ul ul{padding-left:1rem;display:block;}
    #main{flex:1;display:flex;flex-direction:column;position:relative;}
    .controls{display:flex;gap:0.5rem;align-items:center;padding:1rem;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.1);z-index:5;}
    .controls button{padding:0.5rem;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,0.05);font-size:0.9rem;}
    .controls button.active{background:#007bff;color:#fff;border-color:#007bff;}
    #editBtn{margin-left:auto;}
    .chart-container{flex:1;padding:1rem;position:relative;}
    canvas{background:#fff;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);width:100% !important;height:100% !important;}
    #drawer{position:absolute;top:0;right:-300px;width:300px;height:100%;background:#fff;box-shadow:-2px 0 8px rgba(0,0,0,0.1);transition:right 0.3s ease;z-index:20;padding:1rem;overflow-y:auto;}
    #drawer.open{right:0;}
    #drawer h2{margin-top:0;font-size:1.2rem;font-weight:600;}
    #drawer label{display:block;margin:0.5rem 0;cursor:pointer;}
    #changeInfo{position:absolute;top:80px;right:20px;background:rgba(255,255,255,0.8);padding:0.3rem 0.6rem;border-radius:4px;font-weight:600;display:none;z-index:10;}
  </style>
</head>
<body>
  <header><h1>Miary Podaży Pieniądza w Polsce</h1></header>
  <div class="wrapper">
    <aside id="sidebar"><ul id="treeMenu"></ul></aside>
    <main id="main">
      <div class="controls" id="rangeButtons">
        <button data-range="YTD">Od początku roku</button>
        <button data-range="1Y">1 rok</button>
        <button data-range="5Y">5 lat</button>
        <button data-range="10Y">10 lat</button>
        <button data-range="ALL">Cały okres</button>
        <button id="editBtn">EDYTUJ</button>
      </div>
      <div class="chart-container">
        <canvas id="moneyChart"></canvas>
        <div id="changeInfo"></div>
        <div id="drawer">
          <h2>Ustawienia wykresu</h2>
          <label><input type="radio" name="mode" value="normal" checked> Domyślny</label>
          <label><input type="radio" name="mode" value="stacked"> Wykres skumulowany</label>
          <label><input type="radio" name="mode" value="pct"> Zmiana procentowa</label>
          <label><input type="radio" name="mode" value="pct_rr"> Zmiana procentowa r/r</label>
        </div>
      </div>
    </main>
  </div>
  <script>
    let rawData,chart,mode='normal';
    async function loadData(){rawData=await fetch('am_data.json').then(r=>r.json());buildTree();initControls();createChart();setTimeout(()=>document.querySelector('[data-index="22"]').click(),100);}    
    function initControls(){
      document.querySelectorAll('#rangeButtons button[data-range]').forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('#rangeButtons button[data-range]').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderChart();}));
      document.querySelector('button[data-range="ALL"]').classList.add('active');
      document.getElementById('editBtn').addEventListener('click',()=>document.getElementById('drawer').classList.toggle('open'));
      document.querySelectorAll('#drawer input[name="mode"]').forEach(r=>r.addEventListener('change',e=>{mode=e.target.value;renderChart();}));
    }
    function buildTree(){const cols=rawData.columns;const data=[{name:'Pieniądz M3',index:22,children:[{name:'Dodatkowe komponenty M3',index:null,children:[{name:cols[19].column,index:19},{name:cols[20].column,index:20},{name:cols[21].column,index:21}]},{name:'Pieniądz M2',index:18,children:[{name:'Depozyty do 2 lat',index:11,children:cols.slice(12,18).map((c,i)=>({name:c.column,index:12+i}))},{name:'Pieniądz M1',index:10,children:[{name:'Depozyty bieżące',index:3,children:cols.slice(4,10).map((c,i)=>({name:c.column,index:4+i}))},{name:cols[0].column,index:0}]}]}]}];
      function render(nodes,parent){nodes.forEach(n=>{let li=document.createElement('li'),div=document.createElement('div');div.classList.add('node');if(n.index!==null){let cb=document.createElement('input');cb.type='radio';cb.name='series';cb.dataset.index=n.index;div.appendChild(cb);}let span=document.createElement('span');span.textContent=n.name;div.appendChild(span);div.addEventListener('click',e=>{e.stopPropagation();document.querySelectorAll('.node').forEach(x=>x.classList.remove('active'));div.classList.add('active');renderChart();});li.appendChild(div);parent.appendChild(li);if(n.children){let ul=document.createElement('ul');li.appendChild(ul);render(n.children,ul);}});} render(data,document.getElementById('treeMenu'));}
    function createChart(){let ctx=document.getElementById('moneyChart').getContext('2d');chart=new Chart(ctx,{type:'line',data:{datasets:[]},options:{responsive:true,interaction:{mode:'index',intersect:false},plugins:{tooltip:{enabled:true}},scales:{x:{type:'time',time:{unit:'month'}},y:{stacked:false}}}});}    
    function getData(idx){let arr=rawData.columns[idx].data.map(d=>({x:d.date,y:d.value}));let r=document.querySelector('#rangeButtons button.active').dataset.range;let now=new Date(),start;switch(r){case'YTD':start=new Date(now.getFullYear(),0,1);break;case'1Y':start=new Date(now.getFullYear()-1,now.getMonth(),now.getDate());break;case'5Y':start=new Date(now.getFullYear()-5,now.getMonth(),now.getDate());break;case'10Y':start=new Date(now.getFullYear()-10,now.getMonth(),now.getDate());break;}return start?arr.filter(p=>new Date(p.x)>=start):arr;}    
    function renderChart(){let el=document.querySelector('.node.active');if(!el)return;let idx=parseInt(el.querySelector('input[data-index]').dataset.index,10);let base=getData(idx);let ds={label:rawData.columns[idx].column,data:base,borderWidth:2,tension:0.3,fill:false,stack:undefined};let sets=[ds];document.getElementById('changeInfo').style.display='none';switch(mode){case'stacked':chart.options.scales.y.stacked=true;sets[0].fill='origin';sets[0].stack='stack1';break;default:chart.options.scales.y.stacked=false;}if(mode==='pct'||mode==='pct_rr'){let last=base[base.length-1].y,prev;if(mode==='pct')prev=base[base.length-2].y;else{let ld=new Date(base[base.length-1].x),ya=new Date(ld);ya.setFullYear(ld.getFullYear()-1);let m=base.find(p=>new Date(p.x).getFullYear()===ya.getFullYear()&&new Date(p.x).getMonth()===ya.getMonth());prev=m?m.y:NaN;}let pct=((last-prev)/prev*100).toFixed(2);let ci=document.getElementById('changeInfo');ci.textContent=(mode==='pct'?'Δ %':'Δ r/r %')+' '+pct+' %';ci.style.display='block';}chart.data.datasets=sets;chart.update();}
    loadData();
  </script>
</body>
</html>
