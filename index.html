<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podaż pieniądza w Polsce</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Podaż pieniądza w Polsce</h1>
        <div class="mb-4">
            <label>Jeśli dane nie wczytały się automatycznie, wybierz plik JSON (np. am_data.json):</label>
            <input type="file" id="fileInput" accept=".json" />
        </div>
        <div id="error" class="error hidden"></div>
        <div id="loading" class="loading">Wczytywanie danych...</div>
        <div class="flex-container">
            <div id="menu" class="menu"></div>
            <div class="chart-section">
                <h2 id="chartTitle">Pieniądz M3</h2>
                <div class="chart-controls">
                    <div id="chartControls" class="hidden">
                        <button id="backButton">Wstecz</button>
                    </div>
                    <div>
                        <label for="timeRange">Zakres czasowy:</label>
                        <select id="timeRange">
                            <option value="all">Wszystko</option>
                            <option value="ytd">YTD</option>
                            <option value="1y">1 rok</option>
                            <option value="5y">5 lat</option>
                            <option value="10y">10 lat</option>
                        </select>
                    </div>
                </div>
                <canvas id="chart"></canvas>
            </div>
        </div>
        <footer>
            <p>Dane: Narodowy Bank Polski. M3 obejmuje M2, operacje repo, papiery dłużne i fundusze rynku pieniężnego.</p>
        </footer>
    </div>
    <script>
        console.log("Ładowanie aplikacji...");

        // Sprawdzenie, czy Chart.js się załadował
        if (typeof Chart === 'undefined') {
            console.error("Błąd: Chart.js nie załadował się poprawnie.");
            displayError("Błąd: Chart.js nie załadował się poprawnie. Sprawdź połączenie z internetem.");
        } else {
            console.log("Chart.js załadowany poprawnie:", Chart.version);
        }

        // Hierarchy definition
        const hierarchy = {
            name: "Pieniądz M3",
            column_id: 23,
            children: [
                {
                    name: "Pieniądz M2",
                    column_id: 19,
                    children: [
                        {
                            name: "Pieniądz M1",
                            column_id: 11,
                            children: [
                                {
                                    name: "Gotówka w obiegu (poza kasami MIF)",
                                    column_id: 1,
                                    children: [
                                        { name: "Gotówka w obiegu (z kasami MIF)", column_id: 2 },
                                        { name: "Gotówka w kasach MIF", column_id: 3 }
                                    ]
                                },
                                {
                                    name: "Depozyty bieżące",
                                    column_id: 4,
                                    children: [
                                        { name: "Gospodarstwa domowe", column_id: 5 },
                                        { name: "Pozostałe instytucje finansowe", column_id: 6 },
                                        { name: "Przedsiębiorstwa niefinansowe", column_id: 7 },
                                        { name: "Instytucje niekomercyjne", column_id: 8 },
                                        { name: "Instytucje samorządowe", column_id: 9 },
                                        { name: "Fundusze zabezpieczenia społecznego", column_id: 10 }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "Depozyty do 2 lat",
                            column_id: 12,
                            children: [
                                { name: "Gospodarstwa domowe", column_id: 13 },
                                { name: "Pozostałe instytucje finansowe", column_id: 14 },
                                { name: "Przedsiębiorstwa niefinansowe", column_id: 15 },
                                { name: "Instytucje niekomercyjne", column_id: 16 },
                                { name: "Instytucje samorządowe", column_id: 17 },
                                { name: "Fundusze zabezpieczenia społecznego", column_id: 18 }
                            ]
                        }
                    ]
                },
                { name: "Operacje z przyrzeczeniem odkupu", column_id: 20 },
                { name: "Emisja dłużnych papierów wartościowych do 2 lat", column_id: 21 },
                { name: "Emisja udziałów w funduszach rynku pieniężnego", column_id: 22 }
            ]
        };

        // State
        let data = null;
        let selectedCategory = hierarchy;
        let selectedPath = [23];
        let chart = null;
        let timeRange = 'all'; // Domyślny zakres czasowy

        // Function to generate dates from period codes
        function getDateFromPeriod(period) {
            const startDate = new Date(1996, 11, 31); // 1996-12-31 corresponds to period 35430
            const months = Math.floor((period - 35430) / 30.42); // Approximate months
            const date = new Date(startDate);
            date.setMonth(startDate.getMonth() + months);
            return date.toISOString().split("T")[0]; // YYYY-MM-DD
        }

        // Function to filter data by time range
        function filterDataByTimeRange(fullData) {
            if (!fullData || !fullData.length) return [];

            const latestDate = new Date(fullData[fullData.length - 1].date);
            let startDate;

            switch (timeRange) {
                case 'ytd':
                    startDate = new Date(latestDate.getFullYear(), 0, 1); // Początek bieżącego roku
                    break;
                case '1y':
                    startDate = new Date(latestDate);
                    startDate.setFullYear(latestDate.getFullYear() - 1);
                    break;
                case '5y':
                    startDate = new Date(latestDate);
                    startDate.setFullYear(latestDate.getFullYear() - 5);
                    break;
                case '10y':
                    startDate = new Date(latestDate);
                    startDate.setFullYear(latestDate.getFullYear() - 10);
                    break;
                case 'all':
                default:
                    return fullData; // Wszystkie dane
            }

            return fullData.filter(d => new Date(d.date) >= startDate);
        }

        // Function to show/hide elements
        function showElement(id, show = true) {
            document.getElementById(id).classList.toggle('hidden', !show);
        }

        // Function to display error
        function displayError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            showElement('error', true);
            showElement('loading', false);
        }

        // Function to render menu
        function renderMenu(node, parentElement, path = []) {
            const isSelected = path.includes(node.column_id);
            const button = document.createElement('button');
            button.className = isSelected ? 'active' : '';
            button.textContent = node.name;
            button.title = node.name;
            button.addEventListener('click', () => handleSelectCategory(node));
            parentElement.appendChild(button);

            if (node.children && isSelected) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'submenu';
                node.children.forEach(child => renderMenu(child, childrenDiv, path));
                parentElement.appendChild(childrenDiv);
            }
        }

        // Function to handle category selection
        function handleSelectCategory(node) {
            selectedCategory = node;
            const newPath = [...selectedPath];
            const index = newPath.indexOf(node.column_id);
            if (index === -1) {
                newPath.push(node.column_id);
            } else {
                newPath.splice(index + 1);
            }
            selectedPath = newPath;
            updateUI();
        }

        // Function to handle back button
        function handleBack() {
            if (selectedPath.length > 1) {
                const newPath = selectedPath.slice(0, -1);
                const parentId = newPath[newPath.length - 1];
                const findNode = (node, id) => {
                    if (node.column_id === id) return node;
                    if (node.children) {
                        for (let child of node.children) {
                            const found = findNode(child, id);
                            if (found) return found;
                        }
                    }
                    return null;
                };
                selectedCategory = findNode(hierarchy, parentId);
                selectedPath = newPath;
                updateUI();
            }
        }

        // Function to update UI
        function updateUI() {
            // Update menu
            const menu = document.getElementById('menu');
            menu.innerHTML = '<h2>Kategorie</h2>';
            renderMenu(hierarchy, menu, selectedPath);

            // Update chart title and controls
            document.getElementById('chartTitle').textContent = selectedCategory.name;
            showElement('chartControls', selectedPath.length > 1);

            // Update chart
            const fullChartData = data?.columns?.find(col => col.column_id === selectedCategory.column_id)?.data.map(d => ({
                date: d.date,
                value: d.value
            })) || [];

            const chartData = filterDataByTimeRange(fullChartData);

            if (chart) chart.destroy();
            const ctx = document.getElementById('chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [{
                        label: selectedCategory.name,
                        data: chartData.map(d => d.value),
                        borderColor: '#3b82f6',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Data' } },
                        y: { title: { display: true, text: 'Wartość (mln zł)' } }
                    },
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#333',
                            bodyColor: '#333',
                            borderColor: '#ccc',
                            borderWidth: 1,
                            cornerRadius: 5,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `Wartość: ${value.toFixed(2)} mln zł`;
                                },
                                title: function(tooltipItems) {
                                    return `Data: ${tooltipItems[0].label}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Load JSON via fetch
        console.log("Próba wczytania pliku JSON przez fetch...");
        fetch('am_data.json')
            .then(response => {
                console.log("Odpowiedź fetch:", response);
                if (!response.ok) {
                    throw new Error('Nie udało się wczytać pliku JSON: ' + response.statusText);
                }
                return response.json();
            })
            .then(jsonData => {
                console.log("Wczytano dane JSON:", jsonData);
                // Fix dates in the data
                data = {
                    columns: jsonData.columns.map(column => ({
                        ...column,
                        data: column.data.map(item => ({
                            ...item,
                            date: getDateFromPeriod(item.period)
                        }))
                    }))
                };
                showElement('loading', false);
                updateUI();
            })
            .catch(err => {
                console.error("Błąd podczas wczytywania JSON przez fetch:", err);
                displayError("Błąd podczas wczytywania pliku JSON: " + err.message);
            });

        // Handle manual file upload
        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            console.log("Wczytywanie pliku JSON przez input:", file.name);
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    console.log("Wczytano dane JSON przez input:", jsonData);
                    if (!jsonData.columns || !Array.isArray(jsonData.columns)) {
                        throw new Error("Niepoprawna struktura pliku JSON. Oczekiwano obiektu z kluczem 'columns'.");
                    }
                    // Fix dates in the data
                    data = {
                        columns: jsonData.columns.map(column => ({
                            ...column,
                            data: column.data.map(item => ({
                                ...item,
                                date: getDateFromPeriod(item.period)
                            }))
                        }))
                    };
                    showElement('error', false);
                    showElement('loading', false);
                    updateUI();
                } catch (err) {
                    console.error("Błąd podczas wczytywania JSON przez input:", err);
                    displayError("Błąd podczas wczytywania pliku JSON: " + err.message);
                }
            };
            reader.readAsText(file);
        });

        // Handle time range selection
        document.getElementById('timeRange').addEventListener('change', (event) => {
            timeRange = event.target.value;
            updateUI();
        });

        // Add event listener for back button
        document.getElementById('backButton').addEventListener('click', handleBack);
    </script>
</body>
</html>
