<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Miary Podaży Pieniądza w Polsce</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Miary Podaży Pieniądza w Polsce</h1>
  </header>

  <div class="controls">
    <div class="range-buttons">
      <button data-range="all">Od początku</button>
      <button data-range="1y">1 rok</button>
      <button data-range="5y">5 lat</button>
      <button data-range="10y">10 lat</button>
      <button data-range="ytd">Od początku roku</button>
    </div>
    <div class="modes">
      <label><input type="checkbox" id="stacked"> Stacked</label>
      <label><input type="checkbox" id="pct"> Δ %</label>
      <label><input type="checkbox" id="pct_rr"> Δ % r/r</label>
    </div>
  </div>

  <div class="wrapper">
    <nav id="treeMenu"></nav>
    <section class="chart-container">
      <canvas id="myChart"></canvas>
      <div id="changeInfo"></div>
    </section>
  </div>

  <footer>
    Źródło danych: 
    <a href="https://nbp.pl/statystyka-i-sprawozdawczosc/statystyka-monetarna-i-finansowa/podaz-pieniadza-m3-i-czynniki-jego-kreacji/" target="_blank">nbp.pl</a>
    &nbsp;|&nbsp;
    Opracowanie: 
    <a href="https://x.com/Dan_Kostecki" target="_blank">@Dan_Kostecki</a>
  </footer>

  <script>
  (async ()=> {
    const res = await fetch('am_data.json');
    const json = await res.json();
    const labels = json.dates.map(d=>new Date(d));
    const rawData = json.data; // tablica [serie][wartości]
    const treeDefs = [
      { name: 'Pieniądz M3', idxs: [22,23,20,21,22] }, // tylko jako korzeń, idx 22 sumujący M2+20+21+22
      { name: 'M2', idxs: [18,19,12] },
      { name: 'M1', idxs: [10,11,4] },
      { name: 'Depozyty bieżące', idxs: [3, [4,5,6,7,8,9]] },
      { name: 'Depozyty do 2 lat', idxs: [11, [12,13,14,15,16,17]] },
      // … w podobny sposób możesz dodać resztę
    ];

    // stan aplikacji
    let selectedSeries = new Set();
    let activeRange = 'all';
    const modes = { stacked:false, pct:false, pct_rr:false };

    // inicjalizacja przycisków zakresów
    document.querySelectorAll('.range-buttons button').forEach(btn=>{
      btn.addEventListener('click', _=>{
        activeRange = btn.dataset.range;
        updateChart();
      });
    });
    // tryby
    ['stacked','pct','pct_rr'].forEach(id=>{
      document.getElementById(id).addEventListener('change', e=>{
        modes[id] = e.target.checked;
        updateChart();
      });
    });

    // budowa drzewa
    const tree = document.getElementById('treeMenu');
    json.categories.forEach((cat, i)=>{
      const node = document.createElement('div');
      node.className = 'node';
      node.dataset.index = i;
      node.innerHTML = `<label>
        <input type="checkbox" data-idx="${i}">
        ${cat}
      </label>`;
      node.querySelector('label').addEventListener('click', e=>{
        if (e.target.tagName!=='INPUT') {
          // wybór głównego – usuwamy poprzednie
          selectedSeries.clear();
          selectedSeries.add(i);
          updateCheckboxes();
          updateChart();
        }
      });
      node.querySelector('input').addEventListener('click', e=>{
        const idx = +e.target.dataset.idx;
        if (e.target.checked) selectedSeries.add(idx);
        else selectedSeries.delete(idx);
        updateChart();
        e.stopPropagation();
      });
      tree.appendChild(node);
    });

    // synchronizacja stanu checkboxów z selectedSeries
    function updateCheckboxes(){
      document.querySelectorAll('#treeMenu input[type=checkbox]').forEach(ch=>{
        ch.checked = selectedSeries.has(+ch.dataset.idx);
      });
    }

    // filtr zakresu czasu
    function filterRange(dataArr){
      const now = labels.length;
      let start = 0;
      switch(activeRange){
        case '1y': start = Math.max(0, now - 12); break;
        case '5y': start = Math.max(0, now - 60); break;
        case '10y': start = Math.max(0, now - 120); break;
        case 'ytd':
          const thisYear = new Date().getFullYear();
          start = labels.findIndex(d=>d.getFullYear()===thisYear);
          if (start<0) start=0;
          break;
      }
      return {
        labs: labels.slice(start),
        vals: dataArr.map(arr=>arr.slice(start))
      };
    }

    // przeróbka danych do Chart.js
    function makeDatasets(){
      const sel = Array.from(selectedSeries);
      const { labs, vals } = filterRange(sel.map(i=>rawData[i]));
      if (modes.pct || modes.pct_rr){
        // pokazujemy tylko liczbę Δ w changeInfo, a na wykresie liniowo każde
        return sel.map((i,j)=>({
          label: json.categories[i],
          data: vals[j],
          borderWidth: 2,
          fill: false
        }));
      }
      // normalnie lub stacked
      return sel.map((i,j)=>({
        label: json.categories[i],
        data: vals[j],
        borderWidth: 2,
        fill: modes.stacked ? 'origin' : false,
        stack: modes.stacked ? 'stack1' : undefined
      }));
    }

    // aktualizacja wykresu i changeInfo
    function updateChart(){
      const ds = makeDatasets();
      myChart.data.labels = filterRange([]).labs; // tylko labels
      myChart.data.datasets = ds;
      myChart.options.scales.y.stacked = modes.stacked;
      myChart.update();

      // procentowe info
      const info = [];
      if (modes.pct || modes.pct_rr){
        ds.forEach(d=> {
          const arr = d.data;
          if (arr.length<2) return;
          let val;
          if (modes.pct){
            const a=arr[arr.length-2], b=arr[arr.length-1];
            val = ((b-a)/a*100).toFixed(2)+' %';
          } else {
            // r/r: szukamy punktu sprzed ~12 elementów
            const n = arr.length;
            if (n<13) return;
            const a=arr[n-13], b=arr[n-1];
            val = ((b-a)/a*100).toFixed(2)+' % r/r';
          }
          info.push(`${d.label}: ${val}`);
        });
      }
      document.getElementById('changeInfo').textContent = info.join(' | ');
    }

    // inicjalizujemy pusty wykres
    const ctx = document.getElementById('myChart').getContext('2d');
    const myChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [] },
      options: {
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: { legend: { position: 'bottom' } },
        scales: {
          x: { type: 'time', time: { unit: 'month' } },
          y: { stacked: false }
        }
      }
    });

    // domyślny wybór M3 (pierwszy w drzewku)
    const first = 0;
    selectedSeries.add(first);
    updateCheckboxes();
    updateChart();
  })();
  </script>
</body>
</html>
